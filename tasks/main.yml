---
- name: include package manager specific vars
  with_first_found:
    - '../vars/pkg-mgr/{{ ansible_pkg_mgr }}.yml'
    - ../vars/pkg-mgr/default.yml
  include_vars: '{{ item }}'

- name: install extension cli dependencies
  package:
    name: '{{ item }}'
    state: present
  with_items: '{{ visual_studio_code_extensions_dependencies }}'

- name: create config directories for users
  become: yes
  become_user: '{{ item.0.username }}'
  file:
    path: '~{{ item.0.username }}/.config'
    state: directory
    mode: 'u=rwx,go=r'
  with_subelements:
    - '{{ users }}'
    - visual_studio_code_extensions
    - skip_missing: yes

- name: create Visual Studio Code directories for users
  become: yes
  become_user: '{{ item.0.username }}'
  file:
    path: '~{{ item.0.username }}/.config/Code/User'
    state: directory
    mode: 'u=rwx,go='
  with_subelements:
    - '{{ users }}'
    - visual_studio_code_extensions
    - skip_missing: yes

- name: install extensions
  become: yes
  become_user: '{{ item.0.username }}'
  visual_studio_code_extensions:
    name: '{{ item.1 }}'
    state: present
  with_subelements:
    - '{{ users }}'
    - visual_studio_code_extensions
    - skip_missing: yes

- name: uninstall extensions
  become: yes
  become_user: '{{ item.0.username }}'
  visual_studio_code_extensions:
    name: '{{ item.1 }}'
    state: absent
  with_subelements:
    - '{{ users }}'
    - visual_studio_code_extensions_absent
    - skip_missing: yes
